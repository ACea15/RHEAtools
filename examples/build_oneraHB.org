* House keeping
#+begin_src elisp :results none
  (setq org-confirm-babel-evaluate nil)
  (require 'org-tempo)
  (setq program_dir0 (concat default-directory "../"))
#+end_src

* INPUT PARAMETERS
#+NAME: python_parameters
#+begin_src python :session py1 :var output="OMEGA_MODE"
  import numpy as np

  MESH_FILE = "1901_inv.su2" #"1901_inv.su2"
  MARKERS_FILE = "sbw_1901.txt" #"sbw_1901.txt" # sbw_1901.txt
  NUM_MODES = 5
  SCALING = 0.1
  MACH_NUMBER = 0.75 #0.75#0.735
  FREESTREAM_TEMPERATURE= 216.66#222.773
  FREESTREAM_PRESSURE= 18752.378694043327#26201.65
  R = 287.058
  gamma = 1.4
  FREESTREAM_VELOCITY= MACH_NUMBER * (FREESTREAM_TEMPERATURE * gamma * R) ** 0.5
  FREESTREAM_DENSITY = FREESTREAM_PRESSURE / (FREESTREAM_TEMPERATURE * R)

  ROOT_WING_CHORD = 3.
  TIP_WING_CHORD= 0.7
  WING_SPAN= 28.
  b = ROOT_WING_CHORD/2

  REDUCED_FREQ = (1e-7, 1e-5, 1e-3, 0.01)
  REDUCED_FREQ = (0.03, 0.05, 0.07, 0.1)
  OMEGA_AERO = (6.0947, 21.0989, 25.0699, 40., 82.9318)
  #OMEGA_MODE = tuple([FREESTREAM_VELOCITY * ki / b  for ki in REDUCED_FREQ for i in range(NUM_MODES)])
  OMEGA_MODE = tuple([FREESTREAM_VELOCITY * ki / b for ki in REDUCED_FREQ])
  AMPL_MODE = [0. for i in range(NUM_MODES)]
  AMPL_MODE[0] = 0.1
  AMPL_MODE = tuple(AMPL_MODE)
  OMEGA_HB = tuple([FREESTREAM_VELOCITY * ki / b for ki in REDUCED_FREQ])#tuple([0, OMEGA_MODE0, -OMEGA_MODE0])
  HB_PERIOD = tuple([2 * np.pi / i for i in OMEGA_HB])

  # (1/3) * π * h * (r² + r * R + R²)
  WING_VOL_TRUN_CONE= 1./3 * np.pi * (WING_SPAN) * ((TIP_WING_CHORD * 0.5)**2 +
      TIP_WING_CHORD * 0.5 * ROOT_WING_CHORD *0.5 + (ROOT_WING_CHORD * 0.5)**2)

  WING_VOL_TRUN_CONE = 1.1
  rho_mat = 400.
  Omega = 6.0947#OMEGA_HB[0]
  # m
  SCALE_PARAM = 1. / (WING_VOL_TRUN_CONE * rho_mat)

  # mu
  AIRFOIL_MASS_RATIO = (WING_VOL_TRUN_CONE * rho_mat) / (np.pi *
                        FREESTREAM_DENSITY * (ROOT_WING_CHORD / 2)**2)

  # FLUTTER_SPEED_INDEX = U/(mu**0.5 * b * omega0)
  # %% (TgammaR) = ((vf*vf)*(b*b)*(w_alpha*w_alpha)*mu) / (Mach*Mach)
  FLUTTER_SPEED_INDEX = MACH_NUMBER * ((FREESTREAM_TEMPERATURE * gamma * R) ** 0.5 /
                         ((b * Omega) * AIRFOIL_MASS_RATIO**0.5))
  #FLUTTER_SPEED_INDEX = 0.00227
  eval(output)
#+end_src

#+RESULTS: python_parameters
| 4.426184098995431 | 7.376973498325718 | 10.327762897656006 | 14.753946996651436 |

#+NAME: python_parameters2
#+begin_src python :session py1 :var ki=1 output="HB_PERIODX" :noweb yes
  ##<<python_parameters>>
  OMEGA_MODE0 = FREESTREAM_VELOCITY * ki / 2
  OMEGA_MODEX = tuple([OMEGA_MODE0 for i in range(NUM_MODES)])
  OMEGA_HBX = tuple([0, OMEGA_MODE0, -OMEGA_MODE0])
  HB_PERIODX = 2 * np.pi / OMEGA_MODE0
  eval(output)
#+end_src

#+RESULTS: python_parameters2
: 0.05678196086426339


#+begin_src bash :results output :noweb yes
  c=0
  n=9
  OMEGA_MODE=<<python_parameters("OMEGA_MODE")>>
  HB_PERIOD=<<python_parameters("HB_PERIOD")>>
    for ki in ${OMEGA_MODE[@]}
      do
      echo "#####"
    done
  OMEGA_MODE1=(1 2 3 4 5 6)
  #echo ${OMEGA_MODE1[*]:1:5}
  #echo ${OMEGA_MODE[4]}
  #echo $(($((c+1))*$n))
  #echo ${HB_PERIOD[$c]}
  echo ${OMEGA_MODE1[@]:0:3}
#+end_src

#+RESULTS:
: #####
: #####
: #####
: #####
: 1 2 3

** MUST BE RUN TO SET ENV VARIABLES and file structure
#+begin_src elisp  :noweb yes :results output
  (setq NUM_MODES (number-to-string <<python_parameters(output="NUM_MODES")>>))
  (setq SCALING (number-to-string <<python_parameters(output="SCALING")>>))
  (print (concat "Number of Modes:" NUM_MODES))
  (print (concat "Scaling:" SCALING))
  (setq output_label "mesh1901")
  ;;(setq local_root (string-trim-right default-directory "/examples/"))
  ;;(setq local_root (replace-regexp-in-string "~" "$HOME" local_root))
  (setq local_root "/home/ac5015/programs/RHEAtools")
  ;;(setq local_root (replace-regexp-in-string ".." "" local_root))
  (setq local_dir "/data/out")
  (setq remote_dir "/runs")
  (setq onera_dir (concat "/ONERA_fac" SCALING))
  (setq mesh_deformation_dir (concat onera_dir "/MeshDeformation_" output_label))
  (setq steady_deformation_dir (concat onera_dir "/SteadyModes_" output_label))
  (setq hb_dir (concat onera_dir "/HB_" output_label))
  (setq mesh_deformation_tangle (concat local_root local_dir mesh_deformation_dir))
  (setq steady_deformation_tangle (concat local_root local_dir steady_deformation_dir))
  (setq HB_tangle (concat local_root local_dir hb_dir))
  (print "ENV VARIABLES SET!!")
  (make-directory mesh_deformation_tangle t)
  (make-directory steady_deformation_tangle t)
  (print "Dirs to tangle created")
#+end_src

#+RESULTS:
: 
: "Number of Modes:5"
: 
: "Scaling:0.1"
: 
: "ENV VARIABLES SET!!"
: 
: "Dirs to tangle created"

* Modal shapes workflow
#+NAME: ModalShapes
#+header: 
#+begin_src bash :noweb yes :dir (print program_dir0) :shebang #!/usr/bin/zsh :results output :var OUTPUT_DIR=(print mesh_deformation_tangle) dir1=(print local_root) NUM_MODES1=(print NUM_MODES) SCALING1=(print SCALING) :tangle (print (concat mesh_deformation_tangle "/generate_modes.sh")) :async

  MARKERS_FILE=<<python_parameters(output="MARKERS_FILE")>>
  echo $dir1
  PYTHONPATH=$PYTHONPATH:$dir1
  python examples/write_cam_modes.py -m $NUM_MODES1 -s $SCALING1 -f filter_sigmoid -d $OUTPUT_DIR -a $MARKERS_FILE
#+end_src

#+RESULTS: ModalShapes
#+begin_example
/home/ac5015/programs/RHEAtools/examples/..
Modes scaling: 0.1
Modes : [0, 1, 2, 3, 4]
Filtering : <function filter_sigmoid at 0x7f5970f6feb0>
Directory : /home/ac5015/programs/RHEAtools/examples/../data/out/ONERA_fac0.1/MeshDeformation_mesh1901
MARKERS_FILE : ./data/in/sbw_1901.txt
DEBUG:   bdf.py:1001                  ---starting BDF.read_bdf of ./data/in/SOL103/polimi-103cam.bdf---
DEBUG:   pybdf.py:558                 opening '/home/ac5015/programs/RHEAtools/data/in/SOL103/polimi-103cam.bdf'
DEBUG:   pybdf.py:558                 opening '/home/ac5015/programs/RHEAtools/data/in/SOL103/stick_wing.bdf'
DEBUG:   pybdf.py:558                 opening '/home/ac5015/programs/RHEAtools/data/in/SOL103/stick_fus.bdf'
DEBUG:   pybdf.py:558                 opening '/home/ac5015/programs/RHEAtools/data/in/SOL103/stick_vtail.bdf'
DEBUG:   pybdf.py:558                 opening '/home/ac5015/programs/RHEAtools/data/in/SOL103/stick_htail.bdf'
DEBUG:   pybdf.py:558                 opening '/home/ac5015/programs/RHEAtools/data/in/SOL103/stick_strut_corrected.bdf'
DEBUG:   pybdf.py:558                 opening '/home/ac5015/programs/RHEAtools/data/in/SOL103/mass_wing.bdf'
DEBUG:   cross_reference.py:151       Cross Referencing...
DEBUG:   bdf.py:1049                  ---finished BDF.read_bdf of ./data/in/SOL103/polimi-103cam.bdf---
---BDF Statistics---
SOL 103

bdf.spcadds[1000]: 1
  SPCADD:  1

bdf.spcs[100001]: 1
  SPC1:    1

bdf.params: 6
  PARAM    : 6

bdf.nodes: 875
  GRID     : 875

bdf.elements: 170
  CBAR     : 170

bdf.rigid_elements: 181
  RBE2     : 181

bdf.properties: 138
  PBAR     : 138

bdf.masses: 328
  CONM2    : 328

bdf.materials: 5
  MAT1     : 5

bdf.methods: 1
  EIGRL    : 1


DEBUG:   op2.py:542                   combine=True
DEBUG:   op2.py:543                   -------- reading op2 with read_mode=1 (array sizing) --------
INFO:    op2_scalar.py:1672           op2_filename = './data/in/SOL103/polimi-103cam.op2'
DEBUG:   op2_reader.py:231            date = (3, 16, 23)
DEBUG:   op2_reader.py:302            mode = 'msc'
DEBUG:   op2_scalar.py:1850             table_name=b'GEOM1'
DEBUG:   op2_scalar.py:1850             table_name=b'GEOM2'
DEBUG:   op2_scalar.py:1850             table_name=b'GEOM4'
DEBUG:   op2_scalar.py:1850             table_name=b'EPT'
DEBUG:   op2_scalar.py:1850             table_name=b'MPT'
DEBUG:   op2_scalar.py:1850             table_name=b'DYNAMICS'
DEBUG:   op2_scalar.py:1850             table_name=b'CASECC'
DEBUG:   op2_scalar.py:1850             table_name=b'OUG1'
DEBUG:   op2.py:562                   -------- reading op2 with read_mode=2 (array filling) --------
DEBUG:   op2_reader.py:231            date = (3, 16, 23)
DEBUG:   op2_reader.py:302            mode = 'msc'
DEBUG:   op2_scalar.py:1850             table_name=b'GEOM1'
DEBUG:   op2_scalar.py:1850             table_name=b'GEOM2'
DEBUG:   op2_scalar.py:1850             table_name=b'GEOM4'
DEBUG:   op2_scalar.py:1850             table_name=b'EPT'
DEBUG:   op2_scalar.py:1850             table_name=b'MPT'
DEBUG:   op2_scalar.py:1850             table_name=b'DYNAMICS'
DEBUG:   op2_scalar.py:1850             table_name=b'CASECC'
DEBUG:   op2_scalar.py:1850             table_name=b'OUG1'
DEBUG:   op2.py:859                   combine_results
DEBUG:   op2.py:575                   finished reading op2
loadcases = [1]
times = [  1.   2.   3.   4.   5.   6.   7.   8.   9.  10.  11.  12.  13.  14.
  15.  16.  17.  18.  19.  20.  21.  22.  23.  24.  25.  26.  27.  28.
  29.  30.  31.  32.  33.  34.  35.  36.  37.  38.  39.  40.  41.  42.
  43.  44.  45.  46.  47.  48.  49.  50.  51.  52.  53.  54.  55.  56.
  57.  58.  59.  60.  61.  62.  63.  64.  65.  66.  67.  68.  69.  70.
  71.  72.  73.  74.  75.  76.  77.  78.  79.  80.  81.  82.  83.  84.
  85.  86.  87.  88.  89.  90.  91.  92.  93.  94.  95.  96.  97.  98.
  99. 100. 101. 102. 103. 104. 105. 106. 107. 108. 109. 110. 111. 112.
 113. 114. 115. 116. 117. 118. 119. 120. 121. 122. 123. 124. 125. 126.
 127. 128. 129. 130. 131. 132. 133. 134. 135. 136. 137. 138. 139. 140.
 141. 142. 143. 144. 145. 146. 147. 148. 149. 150.]

#+end_example

* Mesh deformation workflow
** file for HPC submission
#+begin_src org :tangle (print (concat mesh_deformation_tangle "/run.pbs")) :mkdirp yes
  #!/bin/sh
  #PBS -l walltime=07:59:00
  #PBS -l select=1:ncpus=1:mem=200gb
  ###:mpiprocs=16
  ###PBS -l select=1:ncpus=8:mem=16gb

  module load intel-suite/2020.2
  module load mpi/intel-2019.8.254
  module load anaconda3/personal

  export SU2_RUN=/rds/general/user/ac5015/home/programs/SU2_dev/bin
  export SU2_HOME=/rds/general/user/ac5015/home/programs/SU2_dev
  export PATH=$PATH:$SU2_RUN
  export PYTHONPATH=$PYTHONPATH:$SU2_RUN

  cd $PBS_O_WORKDIR
  SU2_DEF deformation.cfg > log.txt 2> err.txt
  ##cp -r ./* $PBS_O_WORKDIR
#+end_src
** Config file for SU2 deformation
:PROPERTIES:
:header-args: :tangle (print (concat mesh_deformation_tangle "/deformation.cfg")) :mkdirp yes :noweb yes
:END:
*** Init
#+begin_src org
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %                                                                              %
  % SU2 configuration file                                                       %
  % Case description: NACA0012 Laminar simulation (Re 5000)                      %
  % Author: Francisco Palacios                                                   %
  % Institution: Stanford University                                             %
  % Date: Sep 28, 2012                                                           %
  % File Version 5.0.0 "Raven"                                                %
  %                                                                              %
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %
  MESH_OUT_FILENAME= mesh_out.su2
  % deformation params

  DV_KIND= SURFACE_FILE
  %
  % Marker of the surface in which we are going apply the shape deformation
  DV_MARKER= (wing, strut)

  DV_FILENAME= sbw_fordef.dat

  DV_PARAM= ( 1, 0.5 )
  %
  % Value of the shape deformation
  DV_VALUE= 1. %0.01

  % ---------------- MESH DEFORMATION PARAMETERS (NEW SOLVER) -------------------%
  %
  % Use the reformatted pseudo-elastic solver for grid deformation
  DEFORM_MESH= YES
  %
  % Moving markers which deform the mesh
  MARKER_DEFORM_MESH = (wing, strut)
#+end_src
*** Parameters
#+NAME: meshdeformation_parameters
#+begin_src org
  % ------------------------ GRID DEFORMATION PARAMETERS ------------------------%
  %
  % Linear solver or smoother for implicit formulations (FGMRES, RESTARTED_FGMRES, BCGSTAB)
  DEFORM_LINEAR_SOLVER= FGMRES
  %
  % Preconditioner of the Krylov linear solver (ILU, LU_SGS, JACOBI)
  DEFORM_LINEAR_SOLVER_PREC= ILU
  %
  % Number of smoothing iterations for mesh deformation
  DEFORM_LINEAR_SOLVER_ITER= 20
  %
  % Number of nonlinear deformation iterations (surface deformation increments)
  DEFORM_NONLINEAR_ITER= 1
  %
  % Minimum residual criteria for the linear solver convergence of grid deformation
  DEFORM_LINEAR_SOLVER_ERROR= 4E-16
  %
  % Print the residuals during mesh deformation to the console (YES, NO)
  DEFORM_CONSOLE_OUTPUT= YES
  %
  % Deformation coefficient (linear elasticity limits from -1.0 to 0.5, a larger
  % value is also possible)
  DEFORM_COEFF = 1E6
  %
  % Type of element stiffness imposed for FEA mesh deformation (INVERSE_VOLUME,
  %                                           WALL_DISTANCE, CONSTANT_STIFFNESS)
  %%DEFORM_STIFFNESS_TYPE= WALL_DISTANCE
  DEFORM_STIFFNESS_TYPE= INVERSE_VOLUME
  %
  % Deform the grid only close to the surface. It is possible to specify how much
  % of the volumetric grid is going to be deformed in meters or inches (1E6 by default)
  DEFORM_LIMIT = 1E6
  %
  % Visualize the surface deformation (NO, YES)
  %%VISUALIZE_SURFACE_DEF= YES
  %
  % Visualize the volume deformation (NO, YES)
  %%VISUALIZE_VOLUME_DEF= YES
#+end_src
*** Input/output
#+begin_src org
  % ------------------------- INPUT/OUTPUT INFORMATION --------------------------%
  %
  % Mesh input file
  %MESH_FILENAME= ../../../ONERA/M1/0901_inv.su2
  MESH_FILENAME= ../../../ONERA/<<python_parameters(output="MESH_FILE")>>
  MESH_FORMAT= SU2
  TABULAR_FORMAT= CSV
  SCREEN_OUTPUT= (INNER_ITER, WALL_TIME, CAUCHY_DRAG, RMS_DENSITY, AERO_COEFF)
  HISTORY_OUTPUT= (ITER, FLOW_COEFF, CAUCHY, RMS_RES, AERO_COEFF)
  VOLUME_OUTPUT= (COORDINATES, SOLUTION, PRIMITIVE)
  OUTPUT_FILES= (PARAVIEW, SURFACE_PARAVIEW, SURFACE_CSV)
  %
  %
  SOLUTION_FILENAME= restart_flow_00001.csv
  RESTART_FILENAME= restart_flow.csv
  CONV_FILENAME= history.csv
  VOLUME_FILENAME= cube_volume
  SURFACE_FILENAME= cube_surface
#+end_src
*** Solver and BC
#+begin_src org
  % -------------------- BOUNDARY CONDITION DEFINITION --------------------------%
  %
  %
  MARKER_FAR= ( farfield )
  MARKER_SYM= ( symmetry )
  MARKER_EULER= ( wing, strut, fuselage, wing_fairing, strut_fairing )
  MARKER_PLOTTING= ( wing, strut, fuselage, wing_fairing, strut_fairing )
  MARKER_MONITORING= ( wing, strut, fuselage, wing_fairing, strut_fairing )
  %%%%%%%%%%%%%%%%% SOLVER STUFF NOT NEEDED BELOW %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  <<steady_modes_freestream>>
  <<steady_modes_reference>>
  <<steady_modes_numerics>>
#+end_src
** Copy deformed modal shapes files to HPC and run deformation
#+header: :var LOCAL_DIR=(print local_dir) LOCAL_ROOT=(print local_root) REMOTE_DIR=(print remote_dir) MeshDeformation=(print mesh_deformation_dir) NUM_MODES1=(print NUM_MODES)
#+begin_src shell :tangle (print (concat mesh_deformation_tangle "/hpc.sh")) :mkdirp yes :shebang   #!/usr/bin/zsh

  for i in {0..$(($NUM_MODES1-1))..1}
    do
        echo "Copying Interpolated Mode $i"
        sshpass -f $LOCAL_ROOT/examples/pas ssh ac5015@login.hpc.imperial.ac.uk << EOF
        mkdir -p "$HOME/$REMOTE_DIR/$MeshDeformation/M$i"
    exit
  EOF
        sshpass -f $LOCAL_ROOT/examples/pas scp $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformation/SU2_mesh/M$i/sbw_fordef.dat ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$MeshDeformation/M$i/sbw_fordef.dat

        echo "Submitting Mode $i"
        sshpass -f $LOCAL_ROOT/examples/pas scp $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformation/run.pbs ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$MeshDeformation/M$i/run.pbs
        sshpass -f $LOCAL_ROOT/examples/pas scp $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformation/deformation.cfg ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$MeshDeformation/M$i/deformation.cfg

        sshpass -f $LOCAL_ROOT/examples/pas ssh ac5015@login.hpc.imperial.ac.uk << EOF
        cd $HOME/$REMOTE_DIR/$MeshDeformation/M$i/
        qsub run.pbs
    exit
  EOF

  done

#+end_src
** Retrieve paraview surface
#+header: :var LOCAL_DIR=(print local_dir) LOCAL_ROOT=(print local_root) REMOTE_DIR=(print remote_dir) MeshDeformation=(print mesh_deformation_dir) NUM_MODES1=(print NUM_MODES)
#+begin_src shell :tangle (print (concat mesh_deformation_tangle "/retrieve_deformedmesh.sh")) :mkdirp yes :shebang   #!/usr/bin/zsh
  for i in {0..$(($NUM_MODES1-1))..1}
    do
        echo "Copying surface_deformed.vtu from Mode $i"
        sshpass -f $LOCAL_ROOT/examples/pas scp ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$MeshDeformation/M$i/surface_deformed.vtu $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformation/SU2_mesh/M$i/surface_deformed.vtu 

  done
#+end_src

* Steady computation of modal shapes workflow
** file for HPC submission
#+begin_src org :tangle (print (concat steady_deformation_tangle "/run.pbs")) :mkdirp yes :shebang   #!/usr/bin/zsh
  #PBS -l walltime=22:59:00
  #PBS -l select=1:ncpus=1:mem=99gb
  ###:mpiprocs=16
  ###PBS -l select=1:ncpus=8:mem=16gb

  module load intel-suite/2020.2
  module load mpi/intel-2019.8.254
  module load anaconda3/personal

  export SU2_RUN=/rds/general/user/ac5015/home/programs/SU2_dev/bin
  export SU2_HOME=/rds/general/user/ac5015/home/programs/SU2_dev
  export PATH=$PATH:$SU2_RUN
  export PYTHONPATH=$PYTHONPATH:$SU2_RUN

  cd $PBS_O_WORKDIR
  SU2_CFD euler_onera.cfg > log.txt 2> err.txt
  ##cp -r ./* $PBS_O_WORKDIR
#+end_src
** Input SU2 config file for deformation
:PROPERTIES:
:header-args: :tangle (print (concat steady_deformation_tangle "/euler-onera0.cfg")) :mkdirp yes
:END:
*** COMMENT Peter Config
Comment out this and uncomment the ones below for interactive config
#+begin_src org
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %                                                                              %
  % SU2 configuration file                                                       %
  % Case description: UHARWARD-ONERA EULER simulation_______  %
  % Author: ______Peter Nagy___________________________________________________  %
  % Institution: ______________________________________________________________  %
  % Date: 26/01/2023                                                             %
  % File Version 7.4.0 "Blackbird"                                               %
  %                                                                              %
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %
  %
  %
  % ------------- DIRECT, ADJOINT, AND LINEARIZED PROBLEM DEFINITION ------------%
  %
  % Physical governing equations (EULER, NAVIER_STOKES, NS_PLASMA)
  %
  %
  SOLVER= EULER
  MATH_PROBLEM= DIRECT
  AXISYMMETRIC= NO
  %
  RESTART_SOL= NO
  READ_BINARY_RESTART= NO
  %
  %
  OUTPUT_WRT_FREQ=2000
  SCREEN_WRT_FREQ_INNER= 1
  %
  %
  % -------------------- COMPRESSIBLE FREE-STREAM DEFINITION --------------------%
  %
  AOA=0.0
  FREESTREAM_TEMPERATURE= 216.66000000000003 %216.7
  FREESTREAM_PRESSURE= 18752.378694043327
  %
  MACH_NUMBER= 0.75
  SIDESLIP_ANGLE= 0.0
  %
  % ?
  SYSTEM_MEASUREMENTS= SI
  FREESTREAM_OPTION= TEMPERATURE_FS
  INIT_OPTION= TD_CONDITIONS
  %
  % ---------------------- REFERENCE VALUE DEFINITION ---------------------------% 
  % 
  % Reference origin for moment computation (m or in) 
  REF_ORIGIN_MOMENT_X= 0.00
  REF_ORIGIN_MOMENT_Y= 0.00
  REF_ORIGIN_MOMENT_Z= 0.00
  % 
  % Reference length for moment non-dimensional coefficients (m or in) 
  REF_LENGTH= 55.136195 %MAC=3.04 not sure why 55
  % 
  % Reference area for non-dimensional force coefficients (0 implies automatic 
  % calculation) (m^2 or in^2) 
  REF_AREA= 80.0 %160 for full body
  %
  % -------------------- BOUNDARY CONDITION DEFINITION --------------------------%
  %
  %
  MARKER_FAR= ( farfield )
  MARKER_SYM= ( symmetry )
  MARKER_EULER= ( wing, strut, fuselage, wing_fairing, strut_fairing )
  MARKER_PLOTTING= ( wing, strut, fuselage, wing_fairing, strut_fairing )
  MARKER_MONITORING= ( wing, strut, fuselage, wing_fairing, strut_fairing )
  %
  % ------------- COMMON PARAMETERS DEFINING THE NUMERICAL METHOD ---------------%
  %
  %
  NUM_METHOD_GRAD= GREEN_GAUSS
  CFL_NUMBER= 40
  CFL_ADAPT= NO
  CFL_ADAPT_PARAM= ( 1.5, 0.5, 1.0, 100.0 )
  RK_ALPHA_COEFF= ( 0.66667, 0.66667, 1.000000 )
  ITER= 20000
  LINEAR_SOLVER= FGMRES
  LINEAR_SOLVER_ERROR= 1E-6
  LINEAR_SOLVER_PREC= ILU
  LINEAR_SOLVER_ITER= 5
  %
  % -------------------------- MULTIGRID PARAMETERS -----------------------------% 
  % 
  % Multi-grid levels (0 = no multi-grid) 
  MGLEVEL= 0
  % 
  % Multi-grid cycle (V_CYCLE, W_CYCLE, FULLMG_CYCLE) 
  MGCYCLE= V_CYCLE 
  % 
  MG_PRE_SMOOTH= ( 1, 2, 3, 3 ) 
  MG_POST_SMOOTH= ( 0, 0, 0, 0 ) 
  MG_CORRECTION_SMOOTH= ( 0, 0, 0, 0 ) 
  MG_DAMP_RESTRICTION= 0.75 
  MG_DAMP_PROLONGATION= 0.75
  %
  % -------------------- FLOW NUMERICAL METHOD DEFINITION -----------------------%
  %
  %
  CONV_NUM_METHOD_FLOW= JST %ROE
  MUSCL_FLOW= YES
  SLOPE_LIMITER_FLOW= VENKATAKRISHNAN %_WANG
  VENKAT_LIMITER_COEFF= 0.05
  JST_SENSOR_COEFF= ( 0.5, 0.02 )
  TIME_DISCRE_FLOW= EULER_IMPLICIT
  %
  % Higher values than 1 (3 to 4) make the global Jacobian of central schemes (compressible flow 
  % only) more diagonal dominant (but mathematically incorrect) so that higher CFL can be used. 
  CENTRAL_JACOBIAN_FIX_FACTOR= 4.0 
  % 
  %
  % --------------------------- CONVERGENCE PARAMETERS --------------------------%
  %
  %CONV_CRITERIA= RESIDUAL
  CONV_RESIDUAL_MINVAL= -10
  CONV_STARTITER= 10 
  CONV_CAUCHY_ELEMS= 100 %300
  CONV_CAUCHY_EPS= 1E-9 %1E-6
  CONV_FIELD= (DRAG, LIFT)
  %
  %
  % ------------------------- INPUT/OUTPUT INFORMATION --------------------------%
  %
  % Mesh input file
  MESH_FILENAME= ../../MeshDeformation/M+__+/mesh_out.su2
  MESH_FORMAT= SU2
  TABULAR_FORMAT= CSV
  SCREEN_OUTPUT= (INNER_ITER, WALL_TIME, CAUCHY_DRAG, CAUCHY_LIFT, RMS_DENSITY, AERO_COEFF)
  HISTORY_OUTPUT= (ITER, FLOW_COEFF, CAUCHY, RMS_RES, AERO_COEFF)
  VOLUME_OUTPUT= (COORDINATES, SOLUTION, PRIMITIVE, MESH_QUALITY)
  OUTPUT_FILES= ( RESTART_ASCII, SURFACE_CSV, PARAVIEW, SURFACE_PARAVIEW)
  %
  SOLUTION_FILENAME= restart_flow_onera.csv
  RESTART_FILENAME= restart_flow_onera.csv
  CONV_FILENAME= history_onera.csv
  VOLUME_FILENAME= soln_volume_onera.csv
  SURFACE_FILENAME= soln_surface_onera.csv 
  %
  WRT_FORCES_BREAKDOWN= YES
  BREAKDOWN_FILENAME= forces_breakdown_onera.dat  
#+end_src
*** Fluid solver
#+NAME: steady_modes_fluidsolver
#+begin_src org 
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %                                                                              %
  % SU2 configuration file                                                       %
  % Case description: MRSBW VISCOUS SIMULATION RE 16.6M                          %
  % Author: Francisco Palacios                                                   %
  % Institution: Stanford University                                             %
  % Date: Sep 28, 2012                                                           %
  % File Version 5.0.0 "Raven"                                                %
  %                                                                              %
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  % ------------- DIRECT, ADJOINT, AND LINEARIZED PROBLEM DEFINITION ------------%
  %
  % Physical governing equations (EULER, NAVIER_STOKES, NS_PLASMA)
  %                               
  SOLVER = EULER
  %REF_DIMENSIONALIZATION= DIMENSIONAL
  MATH_PROBLEM= DIRECT
  %
  RESTART_SOL= NO
  %WRT_BINARY_RESTART= NO
  READ_BINARY_RESTART= NO
#+end_src
*** Free-stream conditions
#+NAME: steady_modes_freestream
#+begin_src org :noweb yes
  % -------------------- COMPRESSIBLE FREE-STREAM DEFINITION --------------------%
  %
  AOA= 0.0
  FREESTREAM_TEMPERATURE= <<python_parameters(output="FREESTREAM_TEMPERATURE")>>
  FREESTREAM_PRESSURE= <<python_parameters(output="FREESTREAM_PRESSURE")>>
  FREESTREAM_DENSITY= <<python_parameters(output="FREESTREAM_DENSITY")>>
  MACH_NUMBER= <<python_parameters(output="MACH_NUMBER")>>
  SIDESLIP_ANGLE= 0.0
  % ?
  SYSTEM_MEASUREMENTS= SI
  %FREESTREAM_OPTION= TEMPERATURE_FS
  %INIT_OPTION= TD_CONDITIONS
#+end_src
*** Reference values
#+NAME: steady_modes_reference
#+begin_src org 
  % ---------------------- REFERENCE VALUE DEFINITION ---------------------------% 
  % 
  % Reference origin for moment computation (m or in) 
  REF_ORIGIN_MOMENT_X= 0.00
  REF_ORIGIN_MOMENT_Y= 0.00
  REF_ORIGIN_MOMENT_Z= 0.00
  % 
  % Reference length for moment non-dimensional coefficients (m or in) 
  REF_LENGTH= 55.136195 %MAC=3.04 not sure why 55
  % 
  % Reference area for non-dimensional force coefficients (0 implies automatic 
  % calculation) (m^2 or in^2) 
  REF_AREA= 80.0 %160 for full body
  %
#+end_src
*** Boundary conditions
#+NAME: steady_modes_bc
#+begin_src org 
% -------------------- BOUNDARY CONDITION DEFINITION --------------------------%
%
%
MARKER_FAR= ( farfield )
MARKER_SYM= ( symmetry )
MARKER_EULER= ( wing, strut, fuselage, wing_fairing, strut_fairing )
MARKER_PLOTTING= ( wing, strut, fuselage, wing_fairing, strut_fairing )
MARKER_MONITORING= ( wing, strut, fuselage, wing_fairing, strut_fairing )
%
#+end_src
*** Numerics and convergence
#+NAME: steady_modes_numerics
#+begin_src org 
  % ------------- COMMON PARAMETERS DEFINING THE NUMERICAL METHOD ---------------%
  %
  %
  NUM_METHOD_GRAD= GREEN_GAUSS %WEIGHTED_LEAST_SQUARES
  CFL_NUMBER= 40 %10
  CFL_ADAPT= NO
  CFL_ADAPT_PARAM= ( 1.5, 0.5, 1.0, 100.0 )
  RK_ALPHA_COEFF= ( 0.66667, 0.66667, 1.000000 )
  ITER= 700
  LINEAR_SOLVER= FGMRES
  LINEAR_SOLVER_ERROR= 1E-6
  LINEAR_SOLVER_PREC= ILU
  LINEAR_SOLVER_ITER= 5
  % -------------------- FLOW NUMERICAL METHOD DEFINITION -----------------------%
  %
  %
  CONV_NUM_METHOD_FLOW= JST %ROE
  MUSCL_FLOW= YES
  SLOPE_LIMITER_FLOW= VENKATAKRISHNAN %VENKATAKRISHNAN_WANG
  VENKAT_LIMITER_COEFF= 0.05 %0.01
  JST_SENSOR_COEFF= ( 0.5, 0.02 ) 
  TIME_DISCRE_FLOW= EULER_IMPLICIT
  %
  % Higher values than 1 (3 to 4) make the global Jacobian of central schemes (compressible flow 
  % only) more diagonal dominant (but mathematically incorrect) so that higher CFL can be used. 
  CENTRAL_JACOBIAN_FIX_FACTOR= 4.0 
  % 
  %
  %
  % --------------------------- CONVERGENCE PARAMETERS --------------------------%
  %
  %
  %CONV_CRITERIA= RESIDUAL
  CONV_RESIDUAL_MINVAL= -5
  CONV_STARTITER= 10
  CONV_CAUCHY_ELEMS= 100 %300
  CONV_CAUCHY_EPS= 1E-9 %8E-6
  CONV_FIELD= (DRAG, LIFT)
#+end_src
*** Multigrid parameters
#+NAME: steady_modes_multigrid
#+begin_src org
  % -------------------------- MULTIGRID PARAMETERS -----------------------------%
  %
  %
  % Multi-Grid Levels (0 = no multi-grid)
  MGLEVEL= 0
  MGCYCLE= V_CYCLE
  MG_PRE_SMOOTH= (1, 2, 3, 3) %( 1, 2, 2, 2 )
  MG_POST_SMOOTH= ( 0, 0, 0, 0 )
  MG_CORRECTION_SMOOTH= ( 0, 0, 0, 0 )
  MG_DAMP_RESTRICTION= 0.75 %0.85
  MG_DAMP_PROLONGATION= 0.75 %0.85
  %
#+end_src
*** Input/output
#+begin_src org
  % ------------------------- INPUT/OUTPUT INFORMATION --------------------------%
  %
  %
  OUTPUT_WRT_FREQ=1000
  %WRT_CON_FREQ= 1
  SCREEN_WRT_FREQ_INNER= 1 
  % Mesh input file
  MESH_FILENAME= ../../MeshDeformation/M+__+/mesh_out.su2
  MESH_FORMAT= SU2
  TABULAR_FORMAT= CSV
  SCREEN_OUTPUT= (INNER_ITER, WALL_TIME, CAUCHY_DRAG, RMS_DENSITY, AERO_COEFF)
  HISTORY_OUTPUT= (ITER, FLOW_COEFF, CAUCHY, RMS_RES, AERO_COEFF)
  VOLUME_OUTPUT= (COORDINATES, SOLUTION, PRIMITIVE, MESH_QUALITY)
  OUTPUT_FILES= ( RESTART_ASCII, SURFACE_CSV, PARAVIEW, SURFACE_PARAVIEW)
  %
  %
  SOLUTION_FILENAME= restart_flow_onera.csv
  RESTART_FILENAME= restart_flow_onera.csv
  CONV_FILENAME= history_onera.csv
  VOLUME_FILENAME= soln_volume_onera.csv
  SURFACE_FILENAME= soln_surface_onera.csv 
  %
  WRT_FORCES_BREAKDOWN= YES
  BREAKDOWN_FILENAME= forces_breakdown_onera.dat
#+end_src
** Copy files to HPC and run steady
#+NAME: HPC_STEADY_MODES
#+header: :noweb yes :var LOCAL_DIR=(print local_dir) LOCAL_ROOT=(print local_root) REMOTE_DIR=(print remote_dir) MeshDeformationSteady=(print steady_deformation_dir) NUM_MODES1=(print NUM_MODES) MeshDeformation=(print mesh_deformation_dir)
#+begin_src shell :tangle (print (concat steady_deformation_tangle "/hpc.sh")) :mkdirp yes :shebang   #!/usr/bin/zsh
  echo "Running Steady on reference config"
  mkdir -p $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/G0
  #sed "s|MESH_FILENAME=.*|MESH_FILENAME= ../../../ONERA/M1/0901_inv.su2|" $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/euler-onera0.cfg > $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/G0/euler_onera.cfg
  sed "s|MESH_FILENAME=.*|MESH_FILENAME= ../../../ONERA/<<python_parameters(output="MESH_FILE")>>|" $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/euler-onera0.cfg > $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/G0/euler_onera.cfg
  sshpass -f $LOCAL_ROOT/examples/pas ssh ac5015@login.hpc.imperial.ac.uk "mkdir -p $HOME/$REMOTE_DIR/$MeshDeformationSteady/G0"
  sshpass -f $LOCAL_ROOT/examples/pas scp $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/G0/euler_onera.cfg ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$MeshDeformationSteady/G0/euler_onera.cfg
  sshpass -f $LOCAL_ROOT/examples/pas scp $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/run.pbs ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$MeshDeformationSteady/G0/run.pbs
  sshpass -f $LOCAL_ROOT/examples/pas ssh ac5015@login.hpc.imperial.ac.uk << EOF
  cd $HOME/$REMOTE_DIR/$MeshDeformationSteady/G0/
  qsub run.pbs
  exit
  EOF

  for i in {0..$(($NUM_MODES1-1))..1}
    do
        echo "Creating and copying config file for Mode $i"
        mkdir -p $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/M$i
        #sed "s/+__+/$i/" $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/euler-onera0.cfg > $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/M$i/euler_onera.cfg
        sed "s|MESH_FILENAME=.*|MESH_FILENAME= ../../../$MeshDeformation/M$i/mesh_out.su2|" $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/euler-onera0.cfg > $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/M$i/euler_onera.cfg
        sshpass -f $LOCAL_ROOT/examples/pas ssh ac5015@login.hpc.imperial.ac.uk << EOF
        mkdir -p $HOME/$REMOTE_DIR/$MeshDeformationSteady/M$i
        exit
  EOF
        echo "Copying .cfg"
        sshpass -f $LOCAL_ROOT/examples/pas scp $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/M$i/euler_onera.cfg ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$MeshDeformationSteady/M$i/euler_onera.cfg

        echo "Copying run.pbs"
        sshpass -f $LOCAL_ROOT/examples/pas scp $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/run.pbs ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$MeshDeformationSteady/M$i/run.pbs
        sshpass -f $LOCAL_ROOT/examples/pas ssh ac5015@login.hpc.imperial.ac.uk << EOF
        cd $HOME/$REMOTE_DIR/$MeshDeformationSteady/M$i/
        qsub run.pbs
    exit
  EOF

  done
#+end_src
** Retrieve paraview surface
#+header: :var LOCAL_DIR=(print local_dir) LOCAL_ROOT=(print local_root) REMOTE_DIR=(print remote_dir) MeshDeformationSteady=(print steady_deformation_dir) NUM_MODES1=(print NUM_MODES)
#+begin_src shell :tangle (print (concat steady_deformation_tangle "/retrieve_deformedmesh.sh")) :mkdirp yes :shebang   #!/usr/bin/zsh
  sshpass -f $LOCAL_ROOT/examples/pas scp ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$MeshDeformationSteady/G0/soln_surface_onera.vtu $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/G0/soln_surface_onera.vtu 

  for i in {0..$(($NUM_MODES1-1))..1}
    do
        echo "Copying surface_deformed.vtu from Mode $i"
        sshpass -f $LOCAL_ROOT/examples/pas scp ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$MeshDeformationSteady/M$i/soln_surface_onera.vtu $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformationSteady/M$i/soln_surface_onera.vtu 

  done
#+end_src
* HB workflow
** Input SU2 config file
:PROPERTIES:
:header-args: :tangle (print (concat HB_tangle "/euler-onera0.cfg")) :mkdirp yes :noweb yes
:END:
*** Fluid solver
#+begin_src org
<<steady_modes_fluidsolver>>
#+end_src
*** Free-stream conditions
#+begin_src org 
<<steady_modes_freestream>>
#+end_src
*** Harmonic balance solver
**** Unsteady settings
#+begin_src org
  % ------------------------- UNSTEADY SIMULATION -------------------------------%
  %%%%%%n
  % Unsteady simulation (NO, TIME_STEPPING, DUAL_TIME_STEPPING-1ST_ORDER, 
  %                      DUAL_TIME_STEPPING-2ND_ORDER, HARMONIC_BALANCE)
  TIME_MARCHING= HARMONIC_BALANCE
  %
  % Number of time instances (Zones)
  TIME_INSTANCES= 3
  % 
  % Period of Harmonic Balance simulation
  HB_PERIOD= 0.1257
  %
  HB_PRECONDITION= YES
  % List of frequencies to be resolved for harmonic balance method
  OMEGA_HB= (0,50.,-50)
  % 10 periods: 0.5888756403287397
  %
  % Number of internal iterations (dual time method)
  %%INNER_ITER= 110
  %%ITER= 10000
  %
  % Starting direct iteration for unsteady adjoint
  %%UNST_ADJOINT_ITER= 251
  % ----------------------- DYNAMIC MESH DEFINITION -----------------------------%
  SURFACE_MOVEMENT= (DEFORMING, DEFORMING)
  MODAL_IMPOSED= YES
  BOUNDARY_VELOCITY= NO
  HB_VELOCITY= YES
  MODAL_AEROELASTICITY= YES
  %%HB_AEROELASTICITY= YES
  %
  %
  % Motion mach number (non-dimensional). Used for initializing a viscous flow
  % with the Reynolds number and for computing force coeffs. with dynamic meshes.
  MACH_MOTION= <<python_parameters(output="MACH_NUMBER")>>
  %
  % Moving wall boundary marker(s) (NONE = no marker, ignored for RIGID_MOTION)
  MARKER_MOVING= (wing, strut)

#+end_src
**** Constant parameters and input modes
#+begin_src org
  % -------------- AEROELASTIC SIMULATION (Typical Section Model) ---------------%
  % Activated by GRID_MOVEMENT_KIND option
  %
  STRUCTURE_FILENAME= StructuralModel
  STRUCTURAL_POINTS= 423  %% to remove
  STRUCTURAL_DOFS= 3
  RBF_METHOD= 2
  %
  ROOT_WING_CHORD= <<python_parameters(output="ROOT_WING_CHORD")>>
  TIP_WING_CHORD= <<python_parameters(output="TIP_WING_CHORD")>>
  WING_SPAN=  <<python_parameters(output="WING_SPAN")>>
  WING_VOL_TRUN_CONE= <<python_parameters(output="WING_VOL_TRUN_CONE")>>
  SCALE_PARAM= <<python_parameters(output="SCALE_PARAM")>>
  FLUTTER_SPEED_INDEX = <<python_parameters(output="FLUTTER_SPEED_INDEX")>>
  AIRFOIL_MASS_RATIO = <<python_parameters(output="AIRFOIL_MASS_RATIO")>>
  %
  % Solve the aeroelastic equations every given number of internal iterations
  AEROELASTIC_MODES= <<python_parameters(output="NUM_MODES")>>
  %
  OMEGA_AERO= <<python_parameters(output="OMEGA_AERO")>>
  %
  OMEGA_MODE= <<python_parameters(output="OMEGA_MODE")>>
  AMPL_MODE= <<python_parameters(output="AMPL_MODE")>>
  PITCH_NATURAL_FREQUENCY=<<python_parameters(output="Omega")>>
#+end_src

*** Reference values
#+begin_src org
<<steady_modes_reference>>
#+end_src
*** Boundary conditions
#+begin_src org
  <<steady_modes_bc>>
#+end_src
*** Numerical scheme and convergence
#+begin_src org
  <<steady_modes_numerics>>
#+end_src
*** Multigrid parameters
#+begin_src org
  <<steady_modes_multigrid>>
#+end_src
*** COMMENT Grid deformation_old
#+begin_src org
  % ------------------------ GRID DEFORMATION PARAMETERS ------------------------%
  %
  % Linear solver or smoother for implicit formulations (FGMRES, RESTARTED_FGMRES, BCGSTAB)
  DEFORM_LINEAR_SOLVER= FGMRES
  %
  % Preconditioner of the Krylov linear solver (ILU, LU_SGS, JACOBI)
  DEFORM_LINEAR_SOLVER_PREC= LU_SGS
  %
  % Number of smoothing iterations for mesh deformation
  DEFORM_LINEAR_SOLVER_ITER= 15
  %
  % Number of nonlinear deformation iterations (surface deformation increments)
  %
  % Print the residuals during mesh deformation to the console (YES, NO)
  DEFORM_CONSOLE_OUTPUT= YES
  %
  % Minimum residual criteria for the linear solver convergence of grid deformation
  DEFORM_LINEAR_SOLVER_ERROR= 1E-9
  %
  % Type of element stiffness imposed for FEA mesh deformation (INVERSE_VOLUME, 
  %                                          WALL_DISTANCE, CONSTANT_STIFFNESS)
  %DEFORM_STIFFNESS_TYPE= WALL_DISTANCE
  %
#+end_src
*** Grid deformation
#+begin_src org
  <<meshdeformation_parameters>>
#+end_src
*** Input/output information
#+begin_src org
  % ------------------------- INPUT/OUTPUT INFORMATION --------------------------%
  %
  %
  OUTPUT_WRT_FREQ=500
  SCREEN_WRT_FREQ_INNER= 1
  % Mesh input file
  MESH_FILENAME= ../../../ONERA/<<python_parameters(output="MESH_FILE")>>
  MESH_FORMAT= SU2
  TABULAR_FORMAT= CSV
  SCREEN_OUTPUT= (INNER_ITER, WALL_TIME, CAUCHY_DRAG, CAUCHY_LIFT, RMS_DENSITY, AERO_COEFF)
  HISTORY_OUTPUT= (ITER, FLOW_COEFF, CAUCHY, RMS_RES, AERO_COEFF)
  VOLUME_OUTPUT= (COORDINATES, SOLUTION, PRIMITIVE, MESH_QUALITY)
  OUTPUT_FILES= ( RESTART_ASCII, SURFACE_CSV, PARAVIEW, SURFACE_PARAVIEW)
  %
  SOLUTION_FILENAME= restart_flow_onera.csv
  RESTART_FILENAME= restart_flow_onera.csv
  CONV_FILENAME= history_onera.csv
  VOLUME_FILENAME= soln_volume_onera.csv
  SURFACE_FILENAME= soln_surface_onera.csv 
  %
  WRT_FORCES_BREAKDOWN= YES
  BREAKDOWN_FILENAME= forces_breakdown_onera.dat
#+end_src

** File for HPC submission
#+begin_src org :tangle (concat HB_tangle "/run.pbs") :mkdirp yes :shebang   #!/usr/bin/zsh
  #PBS -l walltime=24:59:00
  #PBS -l select=1:ncpus=1:mem=100gb  
  ###:mpiprocs=16
  ###PBS -l select=1:ncpus=8:mem=16gb

  module load intel-suite/2020.2
  module load mpi/intel-2019.8.254
  module load anaconda3/personal

  export SU2_RUN=/rds/general/user/ac5015/home/programs/SU2_dev/bin
  export SU2_HOME=/rds/general/user/ac5015/home/programs/SU2_dev
  export PATH=$PATH:$SU2_RUN
  export PYTHONPATH=$PYTHONPATH:$SU2_RUN

  cd $PBS_O_WORKDIR
  SU2_CFD euler_onera.cfg > log.txt 2> err.txt
  ##cp -r ./* $PBS_O_WORKDIR
#+end_src
** Copy files to HPC and run steady
#+NAME: HPC_HB
#+header: :noweb yes :var LOCAL_DIR=(print local_dir) LOCAL_ROOT=(print local_root) REMOTE_DIR=(print remote_dir) HBDIR=(print hb_dir) NUM_MODES1=(print NUM_MODES) MeshDeformation=(print mesh_deformation_dir) :results output
#+begin_src shell :tangle (print (concat HB_tangle "/hpc.sh")) :mkdirp yes :shebang   #!/usr/bin/zsh
  run_qsub=true
  REDUCED_FREQ=<<python_parameters("REDUCED_FREQ")>>
  echo "Running HB"
  OMEGA_MODE=<<python_parameters("OMEGA_MODE")>>
  OMEGA_HB=<<python_parameters("OMEGA_HB")>>
  HB_PERIOD=<<python_parameters("HB_PERIOD")>>
  echo ${REDUCED_FREQ[@]}
  echo ${HB_PERIOD[@]}
  counter=0
  for ki in "${REDUCED_FREQ[@]}"
    do
    #OMEGA_MODEX=${OMEGA_MODE[*]:$(($counter*$NUM_MODES1)):$(($((counter+1))*$NUM_MODES1))}
    OMEGA_MODEX=( $(for i in {1..$NUM_MODES1}; do echo 0; done) )
    OMEGA_MODEX[1]=${OMEGA_MODE[@]:$counter:1}
    HB_PERIODX=${HB_PERIOD[@]:$counter:1}
    OMEGA_HBX=${OMEGA_HB[@]:$counter:1}
    echo Reduced frequency: $ki
    echo $counter
    echo $HB_PERIODX
    mkdir -p $LOCAL_ROOT/$LOCAL_DIR/$HBDIR/K$ki/
    sshpass -f $LOCAL_ROOT/examples/pas ssh ac5015@login.hpc.imperial.ac.uk "mkdir -p $HOME/$REMOTE_DIR/$HBDIR/K$ki"
    echo "hello"
    sed "s|OMEGA_MODE=.*|OMEGA_MODE= $OMEGA_MODEX|" $LOCAL_ROOT/$LOCAL_DIR/$HBDIR/euler-onera0.cfg > $LOCAL_ROOT/$LOCAL_DIR/$HBDIR/K$ki/euler_onera.cfg
    sed -i "s|OMEGA_HB=.*|OMEGA_HB= (0. $OMEGA_HBX -$OMEGA_HBX)|" $LOCAL_ROOT/$LOCAL_DIR/$HBDIR/K$ki/euler_onera.cfg
    sed -i "s|HB_PERIOD=.*|HB_PERIOD= $HB_PERIODX |" $LOCAL_ROOT/$LOCAL_DIR/$HBDIR/K$ki/euler_onera.cfg
    counter=$(($counter+1))

    echo "Copying files to HPC"
    sshpass -f $LOCAL_ROOT/examples/pas scp $LOCAL_ROOT/$LOCAL_DIR/$HBDIR/K$ki/euler_onera.cfg ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$HBDIR/K$ki/euler_onera.cfg
    sshpass -f $LOCAL_ROOT/examples/pas scp $LOCAL_ROOT/$LOCAL_DIR/$HBDIR/run.pbs ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$HBDIR/K$ki/run.pbs
    sshpass -f $LOCAL_ROOT/examples/pas scp 					$LOCAL_ROOT/$LOCAL_DIR/$MeshDeformation/SU2_mesh/StructuralModel.vertices ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$HBDIR/K$ki/StructuralModel.vertices
    echo "Copying modes"
    for i in {0..$(($NUM_MODES1-1))..1}
        do
        echo "Mode: $i"
        sshpass -f $LOCAL_ROOT/examples/pas scp $LOCAL_ROOT/$LOCAL_DIR/$MeshDeformation/SU2_mesh/StructuralModel.mode$(($i+1)) ac5015@login.hpc.imperial.ac.uk:$HOME/$REMOTE_DIR/$HBDIR/K$ki/StructuralModel.mode$(($i+1))
    done
    if [[ $run_qsub = true ]]; then
    echo "submitting qsub"
    sshpass -f $LOCAL_ROOT/examples/pas ssh ac5015@login.hpc.imperial.ac.uk << EOF
    cd $HOME/$REMOTE_DIR/$HBDIR/K$ki/
       qsub run.pbs
    exit
  EOF
    fi
  done
#+end_src

#+RESULTS: HPC_HB
: Running HB
: 1e-07
: 0.1
: 0.3
: 0.5

* Orchestrator
** Check hpc status
#+begin_src shell :tangle (print (concat local_root local_dir onera_dir "/check_hpc.sh")) :mkdirp yes :shebang   #!/usr/bin/zsh
  echo "Running HPC check."
  echo "qstat:"
  sshpass -f $LOCAL_ROOT/examples/pas ssh ac5015@login.hpc.imperial.ac.uk << EOF
          cd $HOME
          qstat
  exit
  EOF
#+end_src

#+NAME: Check_HPC
#+begin_src bash :dir (print (concat local_root local_dir onera_dir)) :shebang #!/usr/bin/zsh :results output :async
  echo Current directory:
  pwd
  echo RUNNING check_hpc.sh
  zsh check_hpc.sh
#+end_src

** Mesh deformation
*** Orchestrator_MeshDeformation
#+NAME: Orchestrator_MeshDeformation
#+begin_src bash :dir (print mesh_deformation_tangle) :shebang #!/usr/bin/zsh :results output :async
  echo Current directory:
  pwd
  echo RUNNING hpc.sh
  zsh hpc.sh
#+end_src

#+RESULTS: Orchestrator_MeshDeformation
#+begin_example
Current directory:
/home/ac5015/programs/RHEAtools/data/out/ONERA_fac50.0/MeshDeformation_mesh1901
RUNNING hpc.sh
Copying Interpolated Mode 0
Submitting Mode 0
7265080.pbs
Copying Interpolated Mode 1
Submitting Mode 1
7265082.pbs
Copying Interpolated Mode 2
Submitting Mode 2
7265083.pbs
Copying Interpolated Mode 3
Submitting Mode 3
7265084.pbs
Copying Interpolated Mode 4
Submitting Mode 4
7265086.pbs
#+end_example

*** Orchestrator_RecoverParaview
#+NAME: Orchestrator_RecoverParaview
#+begin_src bash :dir (print mesh_deformation_tangle) :shebang #!/usr/bin/zsh :results output :async
  echo Recovering paraview modal shapes:
  echo retrieve_deformedmesh.sh
  zsh retrieve_deformedmesh.sh
#+end_src

#+RESULTS: Orchestrator_RecoverParaview
: Recovering paraview modal shapes:
: retrieve_deformedmesh.sh
: Copying surface_deformed.vtu from Mode 0
: Copying surface_deformed.vtu from Mode 1
: Copying surface_deformed.vtu from Mode 2
: Copying surface_deformed.vtu from Mode 3
: Copying surface_deformed.vtu from Mode 4

** Steady modal shapes
*** Run Steady simulations
#+NAME: Orchestrator_SteadyModes
#+header: 
#+begin_src bash :dir (print steady_deformation_tangle) :shebang #!/usr/bin/zsh :results output 
  echo Current directory:
  pwd
  echo ####################
  echo RUNNING hpc.sh
  zsh hpc.sh
#+end_src

#+RESULTS: Orchestrator_SteadyModes
#+begin_example
Current directory:
/home/ac5015/programs/RHEAtools/data/out/ONERA_fac1.0/SteadyModes_mesh1901

RUNNING hpc.sh
Running Steady on reference config
7304545.pbs
Creating and copying config file for Mode 0
Copying .cfg
Copying run.pbs
7304547.pbs
Creating and copying config file for Mode 1
Copying .cfg
Copying run.pbs
7304549.pbs
Creating and copying config file for Mode 2
Copying .cfg
Copying run.pbs
7304551.pbs
Creating and copying config file for Mode 3
Copying .cfg
Copying run.pbs
7304552.pbs
Creating and copying config file for Mode 4
Copying .cfg
Copying run.pbs
7304553.pbs
#+end_example

*** Recover paraview
#+NAME: Orchestrator_RecoverSteady
#+begin_src bash :dir (print steady_deformation_tangle) :shebang #!/usr/bin/zsh :results output 
  echo Recovering paraview modal shapes:
  echo Running retrieve_deformedmesh.sh
  zsh retrieve_deformedmesh.sh
#+end_src

#+RESULTS: Orchestrator_RecoverSteady

** HB run 
*** Run Steady simulations
#+NAME: Orchestrator_HB
#+begin_src bash :dir (print HB_tangle) :shebang #!/usr/bin/zsh :results output
  echo Current directory:
  pwd
  echo ####################
  echo RUNNING hpc.sh
  #zsh hpc.sh
#+end_src

#+RESULTS: Orchestrator_HB
: Current directory:
: /home/ac5015/programs/RHEAtools/data/out/ONERA_fac0.1/HB_mesh1901
: 
: RUNNING hpc.sh


*** Recover paraview
#+NAME: Orchestrator_RecoverSteady
#+begin_src bash :dir (print HB_tangle) :shebang #!/usr/bin/zsh :results output 
  echo Recovering paraview modal shapes:
  echo Running retrieve_deformedmesh.sh
  zsh retrieve_deformedmesh.sh
#+end_src

#+RESULTS: Orchestrator_RecoverSteady
